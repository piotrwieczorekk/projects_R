---
title: "Predicting Mean pm2.5 - Air Quality in Wroclaw, Poland"
author: "Piotr Wieczorek"
date: "2024-03-03"
output: 
  html_document: 
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=F,message=F)
```

```{r}
rm(list=ls())
```

## Libraries

```{r}
library(tidyverse)
library(prophet)
library(forecast)
library(tseries)
library(lubridate)
library(scales)
library(ggthemr)
library(MLmetrics)
```


## Reading and cleaning the data

```{r}
df <- read.csv("wroclaw_air.csv")
```

```{r}
df <- df %>% 
  select(c(1,2)) %>%
  mutate(date = lubridate::ymd(date))
```

### Handling NA values

```{r}
sum(is.na(df))
```
```{r}
df %>%
  filter(!(complete.cases(.)))
```

```{r}
df <- df %>%
  fill(pm25)
```

```{r}
sum(is.na(df))
```

```{r}
df <- df %>%
  arrange(date)
```

```{r}
tail(df$date)
```

### Adding columns to the data frame

```{r}
df <- df %>%
  mutate(day_of_week = lubridate::wday(date,week_start = 1,label=T))
```


```{r}
df <- df %>%
  mutate(month = lubridate::month(date,label=T)) %>%
  mutate(year = lubridate::year(date))
```


## Exploratory analysis

### Mean pm2.5 for each month in each year

#### In each year there is a spike in january, february, march, october, november, december and a decrease in april, may, june, jule. The pm2.5 index seems to be strongly related to the temperature - heating households with the usage of unecological resources causes smog, which contains pm2.5 particles


```{r,fig.width=12,fig.height=8}
ggthemr(palette="fresh")

df %>%
  group_by(month,year) %>%
  summarize(mean_pm = mean(pm25)) %>%
  ggplot(aes(x=month,y=mean_pm)) +
  geom_bar(stat="identity") + 
  coord_flip() + 
  facet_wrap(~year,scales="free")
```

### Mean pm2.5 for each month in each year - trend

#### The plot pictures the dynamic of pm2.5 in each month by year.

##### There is a noticable improvement in air quality in months: january, february, april, may, july, august, september, october. In remaining months there seems to be no to very little downward trend.

```{r,fig.width=10,fig.height=6}
df %>%
  group_by(month,year) %>%
  summarize(mean_pm = mean(pm25)) %>%
  ggplot(aes(x=year,y=mean_pm)) +
  geom_line() + 
  geom_smooth(method="lm",se=F,alpha=0.5)+
  facet_wrap(~month,scales="free") 
```


### Mean pm2.5 - percentage change in each month by year



```{r,fig.width=12,fig.height=6}
df %>%
  group_by(month,year) %>%
  summarize(mean_pm = mean(pm25)) %>%
  arrange(year,.by.group=T) %>%
  ungroup() %>%
  arrange(month) %>%
  mutate(pct_change =  (mean_pm/dplyr::lag(mean_pm) - 1)) %>%
  mutate(pct_change = round(pct_change,2)) %>%
  mutate(year = as.factor(year)) %>%
  ggplot(aes(x=year,y=pct_change)) + 
  geom_bar(stat="identity") +
  scale_y_continuous(label=percent) + 
  coord_flip()+
  facet_wrap(~month,scales="free")
```


## Using prophet to predict pm2.5

### Preparing the data

#### For the modeling part, mean pm2.5 in monthly fashion will be calculated.



```{r}
df <- df %>%
  group_by(lubridate::year(date),lubridate::month(date)) %>%
  summarize(mean_pm25 = mean(pm25))
```



```{r}
colnames(df)[1] <- "year"
colnames(df)[2] <- "month"
```



```{r}
head(df)
```


### Trend and seasonality plot

#### There is downward trend in the data, which confirms previous conclusions about generally improving air quality in Wroclaw, Poland

#### There is also a lot of seasonality, especially during summer and winter, which was also stated earlier in the EDA part of the project


```{r}
df <- df %>%
  mutate(date = paste0(year,"-",month)) %>%
  mutate(date = lubridate::ym(date)) %>%
  ungroup() %>%
  select(c(4,3)) %>%
  mutate(mean_pm25 = round(mean_pm25,2))
```




```{r}
df <- df %>%
  rename("ds"="date") %>%
  rename("y"="mean_pm25")
```

```{r}
head(df)
```


```{r,fig.width=8}
model <- prophet(df,seasonality.mode = "additive")

future <- make_future_dataframe(model, periods = 12, freq = "month")

forecast <- predict(model,future)

plot_list <- prophet_plot_components(model,forecast)
```


### Plotting predictions

```{r,fig.width=8}
dyplot.prophet(model,forecast,main="Prophet Prediction") 
```

### MAE and MAPE indicators

```{r}
mae <- mean(abs(forecast$yhat - df$y))
print(paste("Mean Absolute Error (MAE):", mae))
```
#### The model was wrong (nominally) by ~10.3 on average

```{r}
mape <- mean(abs((df$y - forecast$yhat) / df$y)) * 100
print(paste0("Mean Absolute Percentage Error (MAPE): ", round(mape,2),"%"))
```
#### The model was wrong (percentwise) by ~17% on average



