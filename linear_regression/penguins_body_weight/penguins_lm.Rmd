---
title: "Penguins - Body Mass Linear Regression"
author: "Piotr Wieczorek"
date: "2024-01-15"
output: 
  html_document: 
    toc: yes
    toc_depth: 4
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE, warning = FALSE)
```


```{r}
rm(list=ls())
```

### Libraries

```{r}
library(tidyverse)
library(caret)
library(naniar)
library(janitor)
library(skimr)
library(scales)
library(palmerpenguins)
library(missForest)
library(gapminder)
library(plotly)
library(ggpubr)
library(corrplot)
library(fastDummies)
library(MLmetrics)
```


### Loading and cleaning the data


```{r}
df <- palmerpenguins::penguins
```

```{r}
head(df)
```

#### Inspecting NA values

```{r}
colSums(is.na(df)) %>%
  sort()
```


```{r}
naniar::miss_var_summary(df) %>%
  mutate(across(where(is.numeric),~round(.x,2))) %>%
  mutate_at(c("pct_miss"),~paste0(.x,"%")) %>%
  filter(n_miss > 0) %>%
  ggplot(aes(x=variable,y=n_miss)) + 
  geom_bar(stat="identity", fill = "#52957E",color="black") +
  labs(x="Variable", y ="Number of missing data points", title = "Missing data by Variable") + 
  theme_minimal(base_size = 12)  
```

```{r}
df %>%
  filter(!complete.cases(.))
```

#### Random Forest imputation

```{r}
df <- missForest(as.data.frame(df))
```


#### Out-of-bag error

```{r}
df$OOBerror
```

```{r}
df <- df$ximp
```


```{r}
df <- df %>%
  mutate(across(where(is.numeric),~round(.x,2))) %>%
  mutate_at(c("sex"),~str_to_sentence(.x)) %>%
  mutate_at(c("sex"),~as.factor(.x)) %>%
  mutate(sex = fct_recode(sex,
                          M = "Male",
                          `F` = "Female")) %>%
  rename(gender = "sex")
```

### Exploratory analysis

#### Plot 1 - Boxplots of numerical variables by gender and species

```{r,fig.width = 12,fig.height=8}
df %>%
  gather(c("bill_length_mm","bill_depth_mm","flipper_length_mm",
           "body_mass_g"), key =  "key", value= "val") %>%
  ggplot(aes(x=species, y = val, fill = gender)) + 
  geom_boxplot(outlier.shape = NA,color="black") + 
  geom_jitter(alpha=0.75,
              shape=21,
              size=2.5,
              position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.2))+
  facet_wrap(~key,scales="free") + 
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(labels = comma) + 
  labs(x="",y="",title = "Boxplots of numerical variables by gender and species")+
  theme_bw(base_size = 14) + 
  theme(strip.text = element_text(size=12))
```

##### Conclusion: Male penguins exhibit higher body mass, flipper length, bill length and bill depth than female penguins across all species


#### Plot 2 - Scatterplots - Relationship between other numerical variables and body mass

```{r,fig.width = 12,fig.height=8}
df %>%
  gather(c("bill_length_mm","bill_depth_mm","flipper_length_mm"),
         key="key",value="val") %>%
  ggplot(aes(x=val,y=body_mass_g,fill=gender)) + 
  geom_point(shape=21,size=2.2,color="black") + 
  facet_wrap(~key + island,scales="free") + 
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(labels = comma) + 
  labs(x="",y="Body mass (g)",title = "Bill Depth, Bill Length, Flipper length vs Body Mass by Gender and Island")+
  theme_bw(base_size = 14) + 
  theme(strip.text = element_text(size=12))
```



#### Plot 3 - Correlation matrix


```{r}
df %>%
  select_if(is.numeric) %>%
  select(-c("year")) %>%
  cor() %>%
  round(.,2) %>%
  corrplot(addCoef.col = TRUE,method = "number", bg = "#EDF0EF",)
```

### Modeling

#### Data partition

```{r}
data_partition <- caret::createDataPartition(df$body_mass_g, p = 0.75, list = FALSE)

train_set <- df[data_partition,]
test_set <- df[-data_partition,]

print(paste("Train set nrow :",nrow(train_set)))
print(paste("Test set nrow :",nrow(test_set)))
```


#### Dummy variables


```{r}

train_set <- fastDummies::dummy_cols(.data=train_set,
                        select_columns = c("species","island","gender","year"),
                        remove_first_dummy = TRUE,
                        remove_selected_columns = TRUE)

test_set <- fastDummies::dummy_cols(.data=test_set,
                        select_columns = c("species","island","gender","year"),
                        remove_first_dummy = TRUE,
                        remove_selected_columns = TRUE)

```



#### Model formula


```{r}
lm_mod <- lm(formula = body_mass_g ~. -year_2008 -year_2009 -island_Torgersen -island_Dream,
             data = train_set)
```


#### Model output

```{r}
print(summary(lm_mod))
```

##### Conclusions:

1. All variables are statistically significant (alpha=0.05)
2. The model was able to explain 88.06% of the predicted variable's variance
3. The residuals are roughly normally distributed (1Q and 3Q are almost symmetric, although there is some right-directed skewness)

### Residuals diagnostic

#### Residuals plots

##### Conclusions:
1. There is no trend between fitted values and residuals (both standarized and non-standarized)
2. The residuals' distribution is roughly normal


```{r}
par(mfrow=c(2,2))
plot(lm_mod)
```

```{r}
test_pred <- predict(lm_mod,newdata = test_set)
```

```{r}
residuals <- test_set$body_mass_g - test_pred
```

```{r}
densityplot(residuals)
```

#### Prediction metrics

##### Conclusions:
1. The model was wrong by **247.188** on average
2. The model was wrong by **6.3%** on average


```{r}
print(paste("MAE: ",round(MAE(y_pred = test_pred, y_true = test_set$body_mass_g),4)))
print(paste("MAPE: ",round(MLmetrics::MAPE(y_pred = test_pred, y_true  = test_set$body_mass_g),4)))
```











